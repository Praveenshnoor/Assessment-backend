/**
 * MCQ Exam Portal - Complete Database Setup Script
 * 
 * This script creates the complete database schema for the MCQ exam portal.
 * Run this script after cloning the repository to set up all required tables,
 * indexes, triggers, and seed data.
 * 
 * FEATURES INCLUDED:
 * ==================
 * 
 * Core Tables:
 * - students: Student profiles with extended fields (phone, address, college, course, etc.)
 * - admins: Admin authentication with bcrypt password hashing
 * - institutes: Institute/university management
 * - tests: Test templates with scheduling, duration, and passing criteria
 * - test_job_roles: Multiple job roles per test with descriptions
 * - questions: MCQ questions with 4 options and correct answers
 * - exams: Exam instances (legacy support)
 * - results: Exam results tracking
 * 
 * Student Features:
 * - student_responses: Individual question responses with correctness tracking
 * - test_attempts: Complete test submission records with scores
 * - test_assignments: Test-to-student assignment mapping
 * - exam_progress: Auto-save functionality with progress tracking
 * 
 * Proctoring Features:
 * - proctoring_sessions: Live proctoring session tracking
 * - proctoring_violations: AI-detected cheating violations
 * 
 * Performance Optimizations:
 * - Comprehensive indexes for all foreign keys
 * - Composite indexes for common query patterns
 * - Optimized for 300+ concurrent users
 * - Query planner optimization with ANALYZE
 * 
 * Seed Data:
 * - Default admin account (admin@example.com / admin123)
 * - Default institutes (Not Specified, Other)
 * 
 * PREREQUISITES:
 * ==============
 * 1. PostgreSQL 12+ installed and running
 * 2. Node.js and npm installed
 * 3. Required npm packages: pg, bcryptjs, dotenv
 * 4. .env file configured with database credentials:
 *    - DB_USER
 *    - DB_HOST
 *    - DB_NAME
 *    - DB_PASSWORD
 *    - DB_PORT (optional, defaults to 5432)
 * 
 * USAGE:
 * ======
 * 1. Clone the repository
 * 2. Navigate to backend directory: cd backend
 * 3. Install dependencies: npm install
 * 4. Configure .env file with your database credentials
 * 5. Run this script: node setup-database.js
 * 
 * The script will create all tables, indexes, and seed data automatically.
 * It's safe to run multiple times (uses IF NOT EXISTS checks).
 * 
 * @author MCQ Exam Portal Team
 * @version 2.0.0
 */

const { Pool } = require('pg');
const bcrypt = require('bcryptjs');
require('dotenv').config();

const pool = new Pool({
    user: process.env.DB_USER,
    host: process.env.DB_HOST,
    database: process.env.DB_NAME,
    password: process.env.DB_PASSWORD,
    port: process.env.DB_PORT || 5432,
});

const createTables = async () => {
    const client = await pool.connect();
    try {
        console.log('üîå Connected to database...');

        // 1. Create Institutes Table (must be created before students)
        console.log('Creating institutes table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS institutes (
                id SERIAL PRIMARY KEY,
                name VARCHAR(255) NOT NULL UNIQUE,
                display_name VARCHAR(255) NOT NULL,
                created_by VARCHAR(255) DEFAULT 'admin',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active BOOLEAN DEFAULT true
            );
        `);

        // Index for institutes
        await client.query(`CREATE INDEX IF NOT EXISTS idx_institutes_name ON institutes(LOWER(name));`);

        // 2. Create Students Table
        console.log('Creating students table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS students (
                id SERIAL PRIMARY KEY,
                firebase_uid VARCHAR(255) UNIQUE NOT NULL,
                full_name VARCHAR(255) NOT NULL,
                email VARCHAR(255) UNIQUE NOT NULL,
                roll_number VARCHAR(100) UNIQUE NOT NULL,
                institute VARCHAR(255) NOT NULL,
                phone VARCHAR(20),
                address TEXT,
                college_name VARCHAR(255),
                course VARCHAR(100),
                specialization VARCHAR(100),
                resume_link VARCHAR(500),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // Indices for students
        await client.query(`CREATE INDEX IF NOT EXISTS idx_students_firebase_uid ON students(firebase_uid);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_students_email ON students(email);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_students_roll_number ON students(roll_number);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_students_created_at ON students(created_at);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_students_resume_link ON students(resume_link) WHERE resume_link IS NOT NULL;`);

        // 2. Create Admins Table
        console.log('Creating admins table...');
        // Note: Matching schema required by adminAuth.js (email, full_name, password_hash)
        await client.query(`
            CREATE TABLE IF NOT EXISTS admins (
                id SERIAL PRIMARY KEY,
                email VARCHAR(255) UNIQUE NOT NULL,
                password_hash VARCHAR(255) NOT NULL,
                full_name VARCHAR(255),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // 3. Create Tests Table
        console.log('Creating tests table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS tests (
                id SERIAL PRIMARY KEY,
                title VARCHAR(255) NOT NULL,
                description TEXT,
                duration INTEGER DEFAULT 60,
                max_attempts INTEGER DEFAULT 1,
                start_datetime TIMESTAMPTZ,
                end_datetime TIMESTAMPTZ,
                status VARCHAR(20) DEFAULT 'draft',
                is_published BOOLEAN DEFAULT false,
                passing_percentage INTEGER DEFAULT 50,
                job_role TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);


        // Indices for tests
        await client.query(`CREATE INDEX IF NOT EXISTS idx_tests_status ON tests(status);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_tests_is_published ON tests(is_published);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_tests_dates ON tests(start_datetime, end_datetime);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_tests_active ON tests(status, start_datetime, end_datetime) WHERE status = 'published';`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_tests_created_at ON tests(created_at);`);

        // 4. Create Test Job Roles Table
        console.log('Creating test_job_roles table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS test_job_roles (
                id SERIAL PRIMARY KEY,
                test_id INTEGER NOT NULL REFERENCES tests(id) ON DELETE CASCADE,
                job_role VARCHAR(255) NOT NULL,
                job_description TEXT,
                is_default BOOLEAN DEFAULT false,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(test_id, job_role)
            );
        `);

        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_job_roles_test_id ON test_job_roles(test_id);`);

        // 5. Create Questions Table
        console.log('Creating questions table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS questions (
                id SERIAL PRIMARY KEY,
                test_id INTEGER NOT NULL REFERENCES tests(id) ON DELETE CASCADE,
                question_text TEXT NOT NULL,
                option_a TEXT NOT NULL,
                option_b TEXT NOT NULL,
                option_c TEXT,
                option_d TEXT,
                correct_option VARCHAR(1) NOT NULL,
                marks INTEGER DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // Create index on test_id for faster lookups
        await client.query(`CREATE INDEX IF NOT EXISTS idx_questions_test_id ON questions(test_id);`);

        // 6. Create Exams Table
        console.log('Creating exams table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS exams (
                id SERIAL PRIMARY KEY,
                name VARCHAR(255) NOT NULL,
                date DATE DEFAULT CURRENT_DATE,
                duration INTEGER DEFAULT 60,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // Indices for exams
        await client.query(`CREATE INDEX IF NOT EXISTS idx_exams_date ON exams(date);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_exams_created_at ON exams(created_at);`);

        // 7. Create Results Table
        console.log('Creating results table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS results (
                id SERIAL PRIMARY KEY,
                student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
                exam_id INTEGER NOT NULL REFERENCES exams(id) ON DELETE CASCADE,
                marks_obtained NUMERIC(10, 2) NOT NULL,
                total_marks NUMERIC(10, 2) NOT NULL,
                status VARCHAR(20),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // Indices for results
        await client.query(`CREATE INDEX IF NOT EXISTS idx_results_student_id ON results(student_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_results_exam_id ON results(exam_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_results_student_exam ON results(student_id, exam_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_results_created_at ON results(created_at);`);

        // 8. Create Student Responses Table (for tracking student answers)
        console.log('Creating student_responses table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS student_responses (
                id SERIAL PRIMARY KEY,
                student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
                test_id INTEGER REFERENCES tests(id) ON DELETE CASCADE,
                question_id INTEGER REFERENCES questions(id) ON DELETE CASCADE,
                selected_option VARCHAR(1),
                is_correct BOOLEAN,
                marks_obtained INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(student_id, question_id)
            );
        `);

        // Indices for student_responses
        await client.query(`CREATE INDEX IF NOT EXISTS idx_student_responses_student ON student_responses(student_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_student_responses_test ON student_responses(test_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_student_responses_question ON student_responses(question_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_student_responses_student_test ON student_responses(student_id, test_id);`);

        // 9. Create Test Attempts Table (to track overall test submissions)
        console.log('Creating test_attempts table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS test_attempts (
                id SERIAL PRIMARY KEY,
                student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
                test_id INTEGER REFERENCES tests(id) ON DELETE CASCADE,
                total_marks INTEGER DEFAULT 0,
                obtained_marks INTEGER DEFAULT 0,
                percentage DECIMAL(5,2),
                time_taken INTEGER,
                submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(student_id, test_id)
            );
        `);

        // Indices for test_attempts
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_attempts_student ON test_attempts(student_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_attempts_test ON test_attempts(test_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_attempts_student_test ON test_attempts(student_id, test_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_attempts_submitted_at ON test_attempts(submitted_at);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_attempts_test_date ON test_attempts(test_id, submitted_at);`);

        // 10. Create Test Assignments Table (for assigning tests to students)
        console.log('Creating test_assignments table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS test_assignments (
                id SERIAL PRIMARY KEY,
                test_id INTEGER REFERENCES tests(id) ON DELETE CASCADE,
                student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
                assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active BOOLEAN DEFAULT true,
                UNIQUE(test_id, student_id)
            );
        `);

        // Create indices for test_assignments
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_assignments_student ON test_assignments(student_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_assignments_test ON test_assignments(test_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_assignments_active ON test_assignments(is_active);`);

        // 11. Create Exam Progress Table (for saving progress)
        console.log('Creating exam_progress table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS exam_progress (
                id SERIAL PRIMARY KEY,
                student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
                test_id INTEGER NOT NULL REFERENCES tests(id) ON DELETE CASCADE,
                answers JSONB,
                time_remaining INTEGER,
                tab_switch_count INTEGER DEFAULT 0,
                current_question INTEGER DEFAULT 0,
                marked_for_review INTEGER[] DEFAULT '{}',
                visited_questions INTEGER[] DEFAULT '{0}',
                warning_count INTEGER DEFAULT 0,
                last_saved TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(student_id, test_id)
            );
        `);

        // Indices for exam_progress
        await client.query(`CREATE INDEX IF NOT EXISTS idx_exam_progress_student_test ON exam_progress(student_id, test_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_exam_progress_student ON exam_progress(student_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_exam_progress_test ON exam_progress(test_id);`);

        // Create trigger function for exam_progress updated_at
        await client.query(`
            CREATE OR REPLACE FUNCTION update_exam_progress_timestamp()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
        `);

        // Create trigger for exam_progress
        await client.query(`DROP TRIGGER IF EXISTS update_exam_progress_timestamp_trigger ON exam_progress;`);
        await client.query(`
            CREATE TRIGGER update_exam_progress_timestamp_trigger
            BEFORE UPDATE ON exam_progress
            FOR EACH ROW
            EXECUTE FUNCTION update_exam_progress_timestamp();
        `);

        // 12. Create Proctoring Sessions Table
        console.log('Creating proctoring_sessions table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS proctoring_sessions (
                id SERIAL PRIMARY KEY,
                student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
                test_id INTEGER REFERENCES tests(id) ON DELETE CASCADE,
                started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                ended_at TIMESTAMP,
                duration_minutes INTEGER,
                connection_status VARCHAR(50) DEFAULT 'active',
                notes TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // Create indices for proctoring_sessions
        await client.query(`CREATE INDEX IF NOT EXISTS idx_proctoring_student ON proctoring_sessions(student_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_proctoring_test ON proctoring_sessions(test_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_proctoring_status ON proctoring_sessions(connection_status);`);

        // 13. Create Proctoring Violations Table
        console.log('Creating proctoring_violations table...');
        await client.query(`
            CREATE TABLE IF NOT EXISTS proctoring_violations (
                id SERIAL PRIMARY KEY,
                student_id VARCHAR(255) NOT NULL,
                test_id INTEGER NOT NULL,
                violation_type VARCHAR(50) NOT NULL,
                severity VARCHAR(20) NOT NULL,
                message TEXT,
                timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // Create indices for proctoring_violations
        await client.query(`CREATE INDEX IF NOT EXISTS idx_student_violations ON proctoring_violations(student_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_test_violations ON proctoring_violations(test_id);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_violation_timestamp ON proctoring_violations(timestamp);`);
        await client.query(`CREATE INDEX IF NOT EXISTS idx_severity ON proctoring_violations(severity);`);

        // 14. Seed Default Admin
        const defaultAdminEmail = 'admin@example.com';
        const defaultAdminPassword = 'admin123';
        const defaultAdminName = 'System Admin';

        const adminCheck = await client.query('SELECT * FROM admins WHERE email = $1', [defaultAdminEmail]);

        if (adminCheck.rows.length === 0) {
            console.log(`Seeding default admin (${defaultAdminEmail})...`);
            const salt = await bcrypt.genSalt(10);
            const hash = await bcrypt.hash(defaultAdminPassword, salt);

            await client.query(
                'INSERT INTO admins (email, password_hash, full_name) VALUES ($1, $2, $3)',
                [defaultAdminEmail, hash, defaultAdminName]
            );
            console.log(`‚úÖ Default admin created: ${defaultAdminEmail} / ${defaultAdminPassword}`);
        } else {
            console.log('‚ÑπÔ∏è Default admin already exists.');
        }

        // 15. Seed Default Institutes
        console.log('Seeding default institutes...');
        const defaultInstitutes = [
            { name: 'not specified', display_name: 'Not Specified' },
            { name: 'other', display_name: 'Other' }
        ];

        for (const institute of defaultInstitutes) {
            await client.query(`
                INSERT INTO institutes (name, display_name, created_by)
                VALUES ($1, $2, 'system')
                ON CONFLICT (name) DO NOTHING
            `, [institute.name, institute.display_name]);
        }

        // 15. Run ANALYZE for query planner optimization
        console.log('Analyzing tables for query optimization...');
        const tables = [
            'students', 'admins', 'tests', 'test_job_roles', 'questions', 
            'exams', 'results', 'student_responses', 'test_attempts', 
            'test_assignments', 'exam_progress', 'proctoring_sessions', 
            'proctoring_violations', 'institutes'
        ];
        
        for (const table of tables) {
            await client.query(`ANALYZE ${table};`);
        }

        console.log('‚úÖ Database setup completed successfully!');
        console.log('üìä Database includes:');
        console.log('   - Students table with profile fields (phone, address, college, course, specialization)');
        console.log('   - Institutes table with default institutes');
        console.log('   - Tests table with job roles, scheduling, and passing percentage');
        console.log('   - Test job roles table for multiple job roles per test');
        console.log('   - Questions and exam management');
        console.log('   - Test assignments for student-test mapping');
        console.log('   - Progress tracking with auto-save functionality');
        console.log('   - Proctoring sessions and violations tracking');
        console.log('   - Performance indexes for 300+ concurrent users');
        console.log('   - Default admin account (admin@example.com / admin123)');

    } catch (err) {
        console.error('‚ùå Error creating tables:', err);
        throw err;
    } finally {
        client.release();
        pool.end();
    }
};

createTables();
